suite: Deployment

templates:
  - deployment.yaml

tests:
  - it: sets readOnlyRootFilesystem in container securityContext when reloader.readOnlyRootFilesystem is true
    set:
      reloader:
        readOnlyRootFilesystem: true
        deployment:
          containerSecurityContext:
            readOnlyRootFilesystem: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: sets readOnlyRootFilesystem in container securityContext even if reloader.deployment.containerSecurityContext is null
    set:
      reloader:
        readOnlyRootFilesystem: true
        deployment:
          containerSecurityContext: null
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: does not override readOnlyRootFilesystem in container securityContext based on reloader.readOnlyRootFilesystem
    set:
      reloader:
        readOnlyRootFilesystem: false
        deployment:
          containerSecurityContext:
            readOnlyRootFilesystem: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: template is still valid with no defined containerSecurityContext
    set:
      reloader:
        readOnlyRootFilesystem: false
        deployment:
          containerSecurityContext: null
    asserts:
      - isEmpty:
          path: spec.template.spec.containers[0].securityContext
